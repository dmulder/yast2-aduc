app: aduc

build:
  packages:
    - linuxdeployqt

ingredients:
  script:
    - REPO="download.opensuse.org/repositories/YaST:/Head/openSUSE_Tumbleweed"
    # TODO: yast2-aduc should be built locally, not pulled from Tumbleweed
    - if [ ! -f yast2-aduc-*.noarch.rpm ] || [ ! -f yast2-adcommon-python-*.noarch.rpm ] ; then wget -r --no-parent -A 'yast2-aduc-*.noarch.rpm' -A 'yast2-adcommon-python-*.noarch.rpm' https://$REPO/noarch && mv $REPO/noarch/*.rpm .; fi
    - if [ ! -f yast2-python3-bindings-*.rpm ] || [ ! -f yast2-core-*.rpm ] || [ ! -f libyui-ncurses10-*.x86_64.rpm ] || [ ! -f yast2-ycp-ui-bindings-*.x86_64.rpm ] || [ ! -f libyui10-*.x86_64.rpm ] ; then wget -r --no-parent -A 'yast2-python3-bindings-*.rpm' -A 'yast2-core-*.rpm' -A 'libyui-ncurses10-*.x86_64.rpm' -A 'yast2-ycp-ui-bindings-*.x86_64.rpm' -A 'libyui10-*.x86_64.rpm' -R 'yast2-core-devel-*.rpm' https://$REPO/x86_64/ && mv $REPO/x86_64/*.rpm .; fi
    - REPO="download.opensuse.org/repositories/devel:/languages:/python:/Factory/openSUSE_Tumbleweed/x86_64"
    - if [ ! -f python3-base-*.x86_64.rpm ] ; then wget -r --no-parent -A 'python3-base-*.x86_64.rpm' -R 'python3-base-32bit-*.rpm' -R 'python3-base-debug*.rpm' https://$REPO && mv $REPO/*.rpm .; fi
    - cp ../aduc.png .
    
script:
  # Extract the rpms
  - rpm2cpio ../yast2-aduc-*.noarch.rpm | cpio -idmv
  - rpm2cpio ../yast2-adcommon-python-*.noarch.rpm | cpio -idmv
  - rpm2cpio ../yast2-python3-bindings-*.rpm | cpio -idmv
  - rpm2cpio ../yast2-core-*.rpm | cpio -idmv
  - rpm2cpio ../libyui-ncurses10-*.x86_64.rpm | cpio -idmv
  - rpm2cpio ../yast2-ycp-ui-bindings-*.x86_64.rpm | cpio -idmv
  - rpm2cpio ../libyui10-*.x86_64.rpm | cpio -idmv
  - rpm2cpio ../python3-base-*.rpm | cpio -idmv
  # Make binaries relocatable
  - pushd usr && find . -type f -exec sed -i -e 's#/usr#././#g' {} \; && popd
  # Put y2base in our path
  - ln -s ../lib/YaST2/bin/y2base usr/bin/y2base
  # Create the desktop file
  - echo "[Desktop Entry]"  >  aduc.desktop
  - echo "Name=aduc"         >> aduc.desktop
  - echo "Exec=y2base aduc ncurses" >> aduc.desktop
  - echo "Terminal=true" >> aduc.desktop
  - echo "Icon=aduc"    >> aduc.desktop
  - echo "Type=Application" >> aduc.desktop
  - echo "Categories=Settings" >> aduc.desktop
  - mv ../aduc.png .
